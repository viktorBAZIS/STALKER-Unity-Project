using UnityEngine;
using UnityEditor;
using System.IO;
using System.Collections.Generic;

public class LocationDataImporter : EditorWindow
{
    [MenuItem("STALKER Tools/Import Locations from CSV")]
    public static void ShowWindow()
    {
        GetWindow<LocationDataImporter>("Location Importer");
    }

    private string csvPath = "";
    private SeamlessWorldStreamer targetStreamer;

    void OnGUI()
    {
        GUILayout.Label("CSV Location Data Importer", EditorStyles.boldLabel);

        // –ü–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ World Streamer
        targetStreamer = (SeamlessWorldStreamer)EditorGUILayout.ObjectField(
            "World Streamer",
            targetStreamer,
            typeof(SeamlessWorldStreamer),
            true
        );

        // –ü–æ–ª–µ –¥–ª—è –ø—É—Ç–∏ –∫ CSV
        EditorGUILayout.LabelField("CSV File Path:", csvPath);

        if (GUILayout.Button("Select CSV File"))
        {
            csvPath = EditorUtility.OpenFilePanel("Select CSV File", "", "csv");
        }

        GUI.enabled = !string.IsNullOrEmpty(csvPath) && targetStreamer != null;

        if (GUILayout.Button("Import Locations"))
        {
            ImportLocationsFromCSV();
        }

        GUI.enabled = true;
    }

    void ImportLocationsFromCSV()
    {
        if (!File.Exists(csvPath))
        {
            Debug.LogError("CSV file not found: " + csvPath);
            return;
        }

        if (targetStreamer == null)
        {
            Debug.LogError("World Streamer not assigned!");
            return;
        }

        try
        {
            string[] lines = File.ReadAllLines(csvPath);
            var locations = new List<SeamlessWorldStreamer.LocationData>();

            int importedCount = 0;

            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            int startLine = lines[0].ToLower().Contains("name") ? 1 : 0;

            for (int i = startLine; i < lines.Length; i++)
            {
                string line = lines[i];
                if (string.IsNullOrEmpty(line)) continue;

                string[] values = ParseCSVLine(line);

                if (values.Length >= 4)
                {
                    var location = new SeamlessWorldStreamer.LocationData();
                    location.locationName = values[0].Trim();

                    // –ü–∞—Ä—Å–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    if (float.TryParse(values[1], out float x) &&
                        float.TryParse(values[2], out float y) &&
                        float.TryParse(values[3], out float z))
                    {
                        location.worldPosition = new Vector3(x, y, z);
                        locations.Add(location);
                        importedCount++;

                        Debug.Log($"üìç –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: {location.locationName} at {location.worldPosition}");
                    }
                    else
                    {
                        Debug.LogWarning($"‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Å—Ç—Ä–æ–∫–µ {i + 1}: {line}");
                    }
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º World Streamer
            targetStreamer.locations = locations;
            EditorUtility.SetDirty(targetStreamer);

            Debug.Log($"‚úÖ –£–°–ü–ï–®–ù–û! –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {importedCount} –ª–æ–∫–∞—Ü–∏–π");
        }
        catch (System.Exception e)
        {
            Debug.LogError($"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e.Message}");
        }
    }

    string[] ParseCSVLine(string line)
    {
        var values = new List<string>();
        bool inQuotes = false;
        string currentValue = "";

        foreach (char c in line)
        {
            if (c == '"')
            {
                inQuotes = !inQuotes;
            }
            else if (c == ',' && !inQuotes)
            {
                values.Add(currentValue);
                currentValue = "";
            }
            else
            {
                currentValue += c;
            }
        }

        values.Add(currentValue);
        return values.ToArray();
    }
}